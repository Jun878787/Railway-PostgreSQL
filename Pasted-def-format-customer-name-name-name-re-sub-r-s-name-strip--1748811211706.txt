def format_customer_name(name):
    """æ ¼å¼åŒ–å®¢æˆ¶å§“å"""
    name = re.sub(r'å§“å[ï¼š:]\s*', '', name).strip()
    if len(name) == 1:
        return f"{name}Ms.R"
    else:
        return name[:3]

def format_amount(text):
    """æ ¼å¼åŒ–é‡‘é¡"""
    # åŒ¹é…é‡‘é¡æ ¼å¼
    patterns = [
        r'(\d+\.?\d*)è¬ç¾é‡‘',
        r'(\d+\.?\d*)è¬',
        r'é‡‘é¡[ï¼š:]\s*(\d+\.?\d*)è¬',
        r'é ç´„é‡‘é¡[ï¼š:]\s*(\d+\.?\d*)è¬',
        r'å­˜å…¥æ“ä½œé‡‘é¡[ï¼š:]\s*(\d+\.?\d*)è¬',
        r'(\d+\.?\d*)å…‹'
    ]
    
    for pattern in patterns:
        match = re.search(pattern, text)
        if match:
            amount = float(match.group(1))
            if 'å…‹' in pattern:
                return f"{amount}å…‹"
            return f"{amount:.1f}è¬"
    return None

def format_time(text):
    """æ ¼å¼åŒ–æ™‚é–“"""
    # æª¢æŸ¥æ˜¯å¦åŒ…å«æ™‚é–“æ¨™è¨˜
    is_afternoon = 'ä¸‹åˆ' in text or 'æ™šä¸Š' in text
    
    # åŒ¹é…æ™‚é–“æ ¼å¼
    time_patterns = [
        r'(\d{1,2})[é»:ï¼š](\d{1,2})?',
        r'(\d{1,2})[.:](\d{2})',
        r'(\d{1,2})[:ï¼š](\d{2})',
        r'(\d{1,2})æ™‚(\d{1,2})?åˆ†?'
    ]
    
    for pattern in time_patterns:
        match = re.search(pattern, text)
        if match:
            hour = int(match.group(1))
            if is_afternoon and hour < 12:
                hour += 12
            minute = int(match.group(2)) if match.group(2) else 0
            return f"{hour:02d}:{minute:02d}"
    return None

def format_address(text):
    """æ ¼å¼åŒ–åœ°å€ï¼Œåªä¿ç•™ç¸£å¸‚å’Œé„‰é®å¸‚å€"""
    # ç§»é™¤æ‹¬è™Ÿå…§çš„å…§å®¹å’Œå…¬å¸åœ°å€
    text = re.sub(r'\ï¼ˆ.*?\ï¼‰|\(.*?\)', '', text)
    text = re.sub(r'å…¬å¸åœ°å€[ï¼š:]\s*', '', text)
    
    # åŒ¹é…ç¸£å¸‚å’Œé„‰é®å¸‚å€
    city_pattern = r'[^\s]{2,3}[ç¸£å¸‚]'
    district_pattern = r'[^\s]{2,3}[é„‰é®å¸‚å€]'
    
    city_match = re.search(city_pattern, text)
    district_match = re.search(district_pattern, text)
    
    if city_match and district_match:
        return f"{city_match.group()}{district_match.group()}"
    
    # å¦‚æœçœ‹èµ·ä¾†åƒåœ°æ¨™ï¼Œå˜—è©¦ä½¿ç”¨ Google Maps API
    if gmaps:
        location = get_location_from_landmark(text)
        if location:
            return location
    
    return None

def format_company(text):
    """æ ¼å¼åŒ–å…¬å¸åç¨±"""
    # ç§»é™¤å¸¸è¦‹çš„å…¬å¸å¾Œç¶´
    text = re.sub(r'å…¬å¸åç¨±[ï¼š:]\s*', '', text)
    text = re.sub(r'[è‚¡ä»½æœ‰é™å…¬å¸å‰µæŠ•é›†åœ˜æ§è‚¡].*$', '', text)
    company = text.strip()
    return f"{company[:2]}æŠ•è³‡" if company else None

def parse_list_message(text):
    """è§£æåˆ—è¡¨è¨Šæ¯å…§å®¹"""
    result = {
        'customer': '',
        'amount': '',
        'time': '',
        'address': '',
        'company': ''
    }
    
    lines = text.split('\n')
    for line in lines:
        line = line.strip()
        if not line:
            continue
            
        # å°‹æ‰¾å®¢æˆ¶åç¨±
        if 'å§“å' in line:
            result['customer'] = format_customer_name(line)
            
        # å°‹æ‰¾é‡‘é¡
        if any(keyword in line for keyword in ['é‡‘é¡', 'è¬', 'å…‹']):
            amount = format_amount(line)
            if amount:
                result['amount'] = amount
            
        # å°‹æ‰¾æ™‚é–“
        if any(keyword in line for keyword in ['æ™‚é–“', 'é»', 'ï¼š', ':', 'æ™‚']):
            time = format_time(line)
            if time:
                result['time'] = time
            
        # å°‹æ‰¾åœ°å€
        if any(keyword in line for keyword in ['åœ°é»', 'åœ°å€']):
            address = format_address(line)
            if address:
                result['address'] = address
            
        # å°‹æ‰¾å…¬å¸åç¨±
        if 'å…¬å¸' in line and 'åœ°å€' not in line:
            company = format_company(line)
            if company:
                result['company'] = company
    
    return result

# åˆå§‹åŒ–åˆ—è¡¨æ ¼å¼åŒ–å™¨
list_formatter = ListFormatter()

@bot.message_handler(func=lambda message: 
    message.text and message.text.strip() == 'åˆ—è¡¨' and 
    message.reply_to_message and 
    message.reply_to_message.text,
    content_types=['text'])
@error_handler
def handle_list_format(message):
    """è™•ç†åˆ—è¡¨æ ¼å¼åŒ–å‘½ä»¤"""
    try:
        # ç²å–è¢«å›è¦†çš„è¨Šæ¯å…§å®¹
        original_text = message.reply_to_message.text
        
        # é©—è­‰æ–‡æœ¬æ ¼å¼
        if not list_formatter.validate_format(original_text):
            bot.reply_to(message, "âŒ ç„¡æ³•è­˜åˆ¥åˆ—è¡¨æ ¼å¼ï¼Œè«‹ç¢ºä¿è¨Šæ¯åŒ…å«å¿…è¦ä¿¡æ¯ï¼ˆå®¢æˆ¶ã€é‡‘é¡ã€æ™‚é–“ã€åœ°å€ã€å…¬å¸ï¼‰")
            return
        
        # æ ¼å¼åŒ–åˆ—è¡¨
        result = list_formatter.format_list(original_text)
        if not result:
            bot.reply_to(message, "âŒ è™•ç†åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤")
            return
        
        # ç™¼é€æ ¼å¼åŒ–å¾Œçš„è¨Šæ¯
        bot.reply_to(message, result['formatted_text'])
        
        # å¦‚æœæœ‰ç¼ºå°‘çš„å­—æ®µï¼Œç™¼é€æç¤º
        if result['missing_fields']:
            warning_text = "âš ï¸ æ³¨æ„ï¼šä»¥ä¸‹è³‡è¨Šæœªèƒ½è­˜åˆ¥ï¼š\n" + "\n".join(f"- {field}" for field in result['missing_fields'])
            bot.reply_to(message, warning_text)
        
        logger.info(f"ç”¨æˆ¶ {message.from_user.username or message.from_user.id} æ ¼å¼åŒ–äº†ä¸€æ¢åˆ—è¡¨")
        
    except Exception as e:
        logger.error(f"è™•ç†åˆ—è¡¨æ ¼å¼åŒ–æ™‚å‡ºéŒ¯: {str(e)}")
        bot.reply_to(message, "âŒ è™•ç†è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤")

# æ·»åŠ åˆ—è¡¨æ ¼å¼èªªæ˜å‘½ä»¤
@bot.message_handler(commands=['list_help'])
@error_handler
def handle_list_help(message):
    """é¡¯ç¤ºåˆ—è¡¨æ ¼å¼èªªæ˜"""
    help_text = """ğŸ“ åˆ—è¡¨æ ¼å¼èªªæ˜
    
æ”¯æŒçš„æ ¼å¼ï¼š
1. æ¨™æº–æ ¼å¼ï¼š
å®¢æˆ¶ï¼šå¼µä¸‰
é‡‘é¡ï¼š1000
æ™‚é–“ï¼š9/1
åœ°å€ï¼šå°åŒ—å¸‚
å…¬å¸ï¼šABCå…¬å¸

2. ç°¡åŒ–æ ¼å¼ï¼š
å¼µä¸‰ 1000å…ƒ 9/1 å°åŒ—å¸‚ ABCå…¬å¸

ä½¿ç”¨æ–¹æ³•ï¼š
1. ç™¼é€åŒ…å«ä»¥ä¸Šä¿¡æ¯çš„è¨Šæ¯
2. å›è¦†è©²è¨Šæ¯è¼¸å…¥ã€Œåˆ—è¡¨ã€

ğŸ” æ”¯æŒçš„å­—æ®µæ¨™è­˜ï¼š
- å®¢æˆ¶/å§“å/åå­—
- é‡‘é¡/è²»ç”¨/åƒ¹æ ¼
- æ™‚é–“/æ—¥æœŸ
- åœ°å€/ä½ç½®/åœ°é»
- å…¬å¸/å–®ä½

âš ï¸ æ³¨æ„ï¼š
- æœªè­˜åˆ¥çš„ä¿¡æ¯å°‡é¡¯ç¤ºç‚ºã€ŒæœªçŸ¥ã€
- æ™‚é–“æ ¼å¼æ”¯æŒï¼šMM/DD æˆ– MM-DD
- é‡‘é¡æ”¯æŒï¼šç´”æ•¸å­—æˆ–å¸¶å–®ä½ï¼ˆå…ƒ/NT/NTDï¼‰"""

    bot.reply_to(message, help_text)